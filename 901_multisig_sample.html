<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="nem2-sdk-0.13.1.js"></script>
<script>$(function() {
const nem = require("/node_modules/nem2-sdk");

//Alice Bob Carol Dave Ellen Frank
const NODE = 'https://catapult-test.opening-line.jp:3001';
const GENERATION_HASH = "453052FDC4EB23BF0D7280C103F7797133A633B68A81986165B76FCE248AB235";
const transactionHttp = new nem.TransactionHttp(NODE);

const alice = nem.Account.generateNewAccount(nem.NetworkType.MIJIN_TEST);
const bob   = nem.Account.generateNewAccount(nem.NetworkType.MIJIN_TEST);
const carol = nem.Account.generateNewAccount(nem.NetworkType.MIJIN_TEST);

const wsEndpoint = NODE.replace('https', 'wss');
const listener = new nem.Listener(wsEndpoint, WebSocket);
listener.open().then(() => {
    listener
    .confirmed(alice.address)
    .subscribe(
        function(_){
            listener.close();
            convertMultisig();
        },
        err => console.error(err));
});

function convertMultisig(){

    const convertIntoMultisigTransaction = nem.ModifyMultisigAccountTransaction.create(
        nem.Deadline.create(),
        2,
        2,
        [
            new nem.MultisigCosignatoryModification(
                nem.MultisigCosignatoryModificationType.Add,
                bob,
            ),
            new nem.MultisigCosignatoryModification(
                nem.MultisigCosignatoryModificationType.Add,
                carol,
            )
        ],
        nem.NetworkType.MIJIN_TEST);

    const aggregateTransaction = nem.AggregateTransaction.createComplete(
        nem.Deadline.create(),
        [convertIntoMultisigTransaction.toAggregate(alice.publicAccount)],
        nem.NetworkType.MIJIN_TEST,
        []
    );

    const signedTransaction =  alice.signTransactionWithCosignatories(
        aggregateTransaction,
        [bob,carol],
        GENERATION_HASH,
    );

    transactionHttp
    .announce(signedTransaction)
    .subscribe(x => {

        $('#items2-ctrl ul').append('<li><a target="_blank" href="' + NODE + '/transaction/' + signedTransaction.hash + '/status">aaa' + signedTransaction.hash + '</a></li>');
        $('#items3-ctrl ul').append('<li><a target="_blank" href="' + NODE + '/transaction/' + signedTransaction.hash + '">aaa' + signedTransaction.hash + '</a></li>');

        console.log(x)
    }, err => console.error(err));
}

})</script>
</head>
<body>
    <h1>sample</h1>
    <h3>state確認</h3><div id="items2-ctrl"><ul></ul></div>
    <h3>confirmed確認</h3><div id="items3-ctrl"><ul></ul></div>
    <div id="btn-ctrl"><button>送信</button></div>
</body>
</html>
